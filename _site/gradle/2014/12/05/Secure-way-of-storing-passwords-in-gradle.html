<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="sebitg.github.io : dev technologies blog">

    <link rel="stylesheet" type="text/css" media="screen" href="/stylesheets/stylesheet.css">

    <title>sebitg.github.io</title>
  </head>
  <body>
  	<div id="header_wrap" class="outer">
  <header class="inner">
     <h1 id="project_title"><a href="http://sebitg.github.io">sebitg.github.io</a></h1>
     <h2 id="project_tagline">Dev technologies blog</h2>
  </header>
</div>
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
      		<h1 id="gradle-secure-way-of-storing-passwords">[Gradle] Secure way of storing passwords</h1>

<h3 id="problem">Problem</h3>
<p>Using passwords in build.gradle file can be cumbersome. The question is, where to store passwords? Typing it directly in build.gralde, or gradle.properties is bad idea (especially when working with git - accidental commit of properties etc.). Fortunatelly, there is good OOTB (Out-of-the-box) solution in gradle, which helps us to solve that problem.</p>

<h3 id="gradle-init-script">Gradle init script</h3>
<p>Gradle offers initialization script mechanism. It is executed before build starts. There are few ways of include init script into our build:</p>

<ul>
  <li>Specify <strong>init.gradle</strong> file anywhere in file system. Then, type in console:</li>
</ul>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">gradle --init-script<span class="o">=</span>/path/to/your/script/init.gradle -q someTask</code></pre></div>

<ul>
  <li>Specify <strong>init.gradle</strong> file in <strong>YOUR_HOME_DIR/.gradle</strong>. Init script will be loaded automatically when executing gradle tasks.</li>
  <li>Specify file ended with <strong>.gradle</strong> in <strong>GRADLE_HOME/.gradle</strong>. Init script will be loaded automatically when executing gradle tasks.</li>
</ul>

<p>You are free to load any dependencies you need in your init sript. A typical way to do that is the following snippet:</p>

<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="kn">import</span> <span class="nn">com.btcgroup.gradleplugin.utils.*</span>

<span class="n">initscript</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span> <span class="nl">group:</span> <span class="s1">&#39;com.btcgroup&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;gralde-plugin-utils&#39;</span><span class="o">,</span> <span class="nl">version:</span> <span class="s1">&#39;1.1.+&#39;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="n">list</span> <span class="o">=</span> <span class="n">Util</span><span class="o">.</span><span class="na">getProjects</span><span class="o">()</span></code></pre></div>

<h3 id="example">Example</h3>
<p>As an example, we will create external properties loader. Properties contain passwords, so the best idea is to store it in secure place. For the purpose of this example, I will store my properties file in the same place, as <strong>init.gradle</strong> script, that’s: <strong>YOUR_HOME_DIR/.gradle</strong>. </p>

<h6 id="init-settingsproperties">init-settings.properties</h6>

<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">archiva</span><span class="o">.</span><span class="na">url</span><span class="o">=</span><span class="nl">http:</span><span class="c1">//localhost:8080/repository/myproject/</span>
<span class="n">archiva</span><span class="o">.</span><span class="na">username</span><span class="o">=</span><span class="n">xxxxx</span>
<span class="n">archiva</span><span class="o">.</span><span class="na">password</span><span class="o">=</span><span class="n">xxxxx</span></code></pre></div>

<h6 id="initgradle">init.gradle</h6>

<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="kn">import</span> <span class="nn">java.util.Properties</span>
<span class="kn">import</span> <span class="nn">java.io.*</span>
<span class="n">allprojects</span> <span class="o">{</span>
	<span class="n">println</span> <span class="s2">&quot;[INIT SCRIPT] Initializing script START...&quot;</span>
	<span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">loadExternalProps</span><span class="o">()</span>
	<span class="n">beforeEvaluate</span> <span class="o">{</span> <span class="n">project</span> <span class="o">-&gt;</span>
		<span class="k">if</span><span class="o">(</span><span class="n">props</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">println</span> <span class="s2">&quot;[INIT SCRIPT] Loading properties for project &quot;</span> <span class="o">+</span> <span class="n">project</span><span class="o">.</span><span class="na">name</span>
			<span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">externalProps</span> <span class="o">=</span> <span class="n">props</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="nf">loadExternalProps</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">String</span> <span class="n">userGradleDir</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s2">&quot;user.home&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="s2">&quot;/.gradle/&quot;</span>
	<span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">userGradleDir</span> <span class="o">+</span> <span class="s2">&quot;init-settings.properties&quot;</span><span class="o">)</span>
	<span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span>
		<span class="k">return</span> <span class="kc">null</span>
	<span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">()</span>
	<span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">))</span>
	<span class="k">return</span> <span class="n">props</span>
<span class="o">}</span></code></pre></div>

<h5 id="whats-happening-there">What’s happening there?</h5>
<ul>
  <li>First of all, we want to evaluate our logic to all projects builded at the time. That’s why we use <code>allprojects</code> clause. </li>
  <li>Right after that, we use <code>beforeEvaluate</code> callback for specific project. Another option is to use <code>afterEvaluate</code> callback, but in case of properties loading, <code>beforeEvaluate</code> is the best choice.</li>
  <li>Including our properties. We do it by adding <code>externalProperties</code> object to <code>ext</code> object of <code>project</code>: <code>project.ext.externalProps = props</code></li>
</ul>

<h5 id="how-to-use-it-in-our-buildgradle-scripts">How to use it in our build.gradle scripts?</h5>
<p>It’s really simple, and refers to use <strong><em>externalProperies</em></strong> object inside <strong><em>build.gradle</em></strong>. Take a look at this example:</p>

<div class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
<span class="o">}</span>
<span class="n">dependencies</span> <span class="o">{</span>
<span class="o">}</span>
<span class="o">...</span>
<span class="n">task</span> <span class="n">someSampleTask</span> <span class="o">&lt;&lt;</span> <span class="o">{</span>
    <span class="n">println</span> <span class="n">externalProps</span><span class="o">[</span><span class="s2">&quot;archiva.username&quot;</span><span class="o">]</span>  <span class="c1">//Example of use</span>
<span class="o">}</span></code></pre></div>

      </section>
    </div>
    <div id="footer_wrap" class="outer">
  <footer class="inner">
    <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
  </footer>
</div>

  </body>
</html>
